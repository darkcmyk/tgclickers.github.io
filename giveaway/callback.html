<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Авторизация</title>
  <link rel="stylesheet" href="common.css">
</head>
<body>
  <div class="container"><h2>Авторизация...</h2></div>
  <script>
    const code = new URLSearchParams(location.search).get("code");
    const state = new URLSearchParams(location.search).get("state");
    if (!code) {
      document.body.innerHTML = "<h3>Ошибка авторизации.</h3>";
    } else {
      fetch(`https://5ecf2cd5-b718-4734-aba6-2259aa598570-00-3s7c11zdialc7.pike.replit.dev/auth/discord?code=${code}`)
        .then(r => r.json())
        .then(data => {
          if (data.user) {
            localStorage.setItem("user", JSON.stringify(data.user));
            location.href = `giveaway.html?id=${state}`;
          } else {
            document.body.innerHTML = "<h3>Ошибка авторизации.</h3>";
          }
        })
        .catch(() => document.body.innerHTML = "<h3>Ошибка сети.</h3>");
    }
  </script>
</body>
</html>
